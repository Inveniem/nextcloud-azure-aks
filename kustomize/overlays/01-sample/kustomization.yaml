##
# Kustomization overlay for deploying Nextcloud to a Kubernetes environment.
#
# This is an EXAMPLE file. Customize for your environment! If you have multiple
# environments, you can create multiple copies of the containing, sample overlay
# folder and customize manifests in each one to match your environments.
#
# @author Guy Elsmore-Paddock (guy@inveniem.com)
# @copyright Copyright (c) 2022, Inveniem
# @license GNU AGPL version 3 or any later version
#
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base
  - manifests/config-environment.yaml
  - manifests/namespace-nextcloud.yaml

components:
### You can pick and choose the optional components you'd like to include by
### uncommenting lines below.
  # - ../../components/sftp-server
  # - ../../components/sftp-ws-server
  - ../../components/ingress-dns

generators:
  - decrypt-secrets.nextcloud.yaml
#### Uncomment this if using the "sftp-server" component:
#  - decrypt-secrets.sftp.yaml

# Uncomment this if using either the "sftp-server" or "sftp-ws-server"
# components.
#configMapGenerator:
#### Uncomment this if using the "sftp-server" component:
#  - name: sftp
#    files:
#      - configs/sftp/users.conf
#
#### Uncomment this if using the "sftp-ws-server" component:
#  - name: sftp-ws
#    files:
#      - originRestrictions=configs/sftp-ws/origin-restrictions.json

transformers:
  - configure-storage.nextcloud.yaml
  # Uncomment this if using the "sftp-server" component:
  #- configure-storage.sftp.yaml
  # Uncomment this if using the "sftp-ws-server" component:
  #- configure-storage.sftp-ws.yaml

patches:
  # Below, fill in the email address you'd like to use for certificate requests.
  - patch: |-
      apiVersion: cert-manager.io/v1
      kind: Issuer
      metadata:
        name: letsencrypt-production
      spec:
        acme:
          email: support@yourcompany.com
namespace: nextcloud-sample

images:
  - name: mkodockx/docker-clamav
    digest: "sha256:09faf0d32b3f6f1169d2428e8226f2ea12bbb8fc3d96acc95ee1278f1a9f39c4"

  - name: inveniem/nextcloud-cron
    newName: your-acr-instance.azurecr.io/inveniem/nextcloud-cron
    newTag: latest

  - name: inveniem/nextcloud-fpm
    newName: your-acr-instance.azurecr.io/inveniem/nextcloud-fpm
    newTag: latest

  - name: inveniem/nextcloud-nginx-middleware
    newName: your-acr-instance.azurecr.io/inveniem/nextcloud-nginx-middleware
    newTag: latest

  - name: inveniem/sftp-ws-server
    newName: your-acr-instance.azurecr.io/inveniem/sftp-ws-server
    newTag: latest
